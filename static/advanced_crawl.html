<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡ - Ø³ÛŒØ³ØªÙ… Ø§Ø®Ø¨Ø§Ø±</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazir-font@33.0.0/dist/font-face.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .bg-gradient { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Ù‡Ø¯Ø± -->
    <div class="bg-gradient text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ø®Ø¨Ø§Ø±</h1>
            <div class="space-x-4">
                <a href="#" id="dashboard-link" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-200">
                    Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <form id="logout-form" method="POST" class="inline">
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        ğŸšª Ø®Ø±ÙˆØ¬
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-6">
        <!-- ÙØ±Ù… Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-6 border-b pb-2">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Ø¨Ø®Ø´ ØªØ§Ø±ÛŒØ® -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">ğŸ“… Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
                            <input type="date" id="adv_date_from" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                            <input type="date" id="adv_date_to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Ø¨Ø®Ø´ Ø²Ø¨Ø§Ù† -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">ğŸŒ Ø²Ø¨Ø§Ù† Ùˆ Ù…Ù†Ø·Ù‚Ù‡</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø²Ø¨Ø§Ù† Ø®Ø¨Ø±</label>
                            <select id="adv_lang" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="english">ğŸ‡ºğŸ‡¸ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</option>
                                <option value="french">ğŸ‡«ğŸ‡· ÙØ±Ø§Ù†Ø³ÙˆÛŒ</option>
                                <option value="german">ğŸ‡©ğŸ‡ª Ø¢Ù„Ù…Ø§Ù†ÛŒ</option>
                                <option value="russian">ğŸ‡·ğŸ‡º Ø±ÙˆØ³ÛŒ</option>
                                <option value="arabic">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÛŒ</option>
                                <option value="chinese">ğŸ‡¨ğŸ‡³ Ú†ÛŒÙ†ÛŒ</option>
                                <option value="azerbaijani">ğŸ‡¦ğŸ‡¿ Ø¢Ø°Ø±ÛŒ</option>
                                <option value="turkish">ğŸ‡¹ğŸ‡· ØªØ±Ú©ÛŒ</option>
                                <option value="spanish">ğŸ‡ªğŸ‡¸ Ø§Ø³Ù¾Ø§Ù†ÛŒØ§ÛŒÛŒ</option>
                                <option value="italian">ğŸ‡®ğŸ‡¹ Ø§ÛŒØªØ§Ù„ÛŒØ§ÛŒÛŒ</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ Ùˆ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Ø¨Ø®Ø´ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                            <input type="text" id="adv_keywords" placeholder="Ù…Ø«Ø§Ù„: nuclear, sanctions, economy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Ú©Ù„Ù…Ø§Øª Ø±Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯</p>
                        </div>
                    </div>
                </div>

                <!-- Ø¨Ø®Ø´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª (1-10)</label>
                            <input type="number" id="adv_pages" min="1" max="10" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ø­Ø¯Ø§Ú©Ø«Ø± Ù†ØªØ§ÛŒØ¬ (1-100)</label>
                            <input type="number" id="adv_limit" min="1" max="100" value="20" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚Ø¯Ø§Ù… -->
            <div class="flex flex-col md:flex-row gap-4 pt-4 border-t border-gray-200">
                <button onclick="startAdvancedCrawl()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition duration-200 text-lg font-medium">
                    ğŸš€ Ø´Ø±ÙˆØ¹ Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡
                </button>
                <button onclick="resetForm()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-200 text-lg font-medium">
                    ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ÙØ±Ù…
                </button>
                <button onclick="testConnection()" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition duration-200 text-lg font-medium">
                    ğŸ”Œ ØªØ³Øª Ø§ØªØµØ§Ù„
                </button>
            </div>
        </div>

        <!-- Ù†ØªØ§ÛŒØ¬ Ùˆ Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Ù†ØªØ§ÛŒØ¬ Ú©Ø±Ø§ÙˆÙ„ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ú©Ø±Ø§ÙˆÙ„</h3>
                <div id="crawl_results" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        Ù‡Ù†ÙˆØ² Ú©Ø±Ø§ÙˆÙ„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                    </div>
                </div>
            </div>

            <!-- Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ğŸ“ Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡</h3>
                    <button onclick="clearLogs()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition duration-200">
                        Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
                    </button>
                </div>
                <div id="live_logs" class="bg-gray-50 p-4 rounded-md text-sm font-mono max-h-96 overflow-y-auto">
                    <div class="text-gray-500">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ú©Ø±Ø§ÙˆÙ„...</div>
                </div>
            </div>
        </div>

        <!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="total_crawled">0</div>
                <div class="text-sm text-gray-600">Ø§Ø®Ø¨Ø§Ø± Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´Ø¯Ù‡</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="success_rate">0%</div>
                <div class="text-sm text-gray-600">Ù…ÛŒØ²Ø§Ù† Ù…ÙˆÙÙ‚ÛŒØª</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="avg_time">0s</div>
                <div class="text-sm text-gray-600">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù†</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="last_crawl">-</div>
                <div class="text-sm text-gray-600">Ø¢Ø®Ø±ÛŒÙ† Ú©Ø±Ø§ÙˆÙ„</div>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø®ÙˆØ¯Ú©Ø§Ø± SECRET_PATH Ø§Ø² URL ÙØ¹Ù„ÛŒ
        const getSecretPath = () => {
            const path = window.location.pathname;
            const match = path.match(/^\/([^\/]+)/);
            return match ? match[1] : 'admin';
        };

        const SECRET_PATH = getSecretPath();

        let crawlLogs = [];
        let crawlStartTime = null;

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', function() {
            // ØªÙ†Ø¸ÛŒÙ… Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
            document.getElementById('dashboard-link').href = `/${SECRET_PATH}/dashboard`;
            document.getElementById('logout-form').action = `/${SECRET_PATH}/logout`;
            
            // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø§Ù…Ø±ÙˆØ² Ùˆ Ø¯ÛŒØ±ÙˆØ²)
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            document.getElementById('adv_date_from').value = yesterday;
            document.getElementById('adv_date_to').value = today;
        });

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const logEntry = `[${timestamp}] ${message}`;
            crawlLogs.push({ message: logEntry, type });
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ù„Ø§Ú¯ Ø²Ù†Ø¯Ù‡
            const logsContainer = document.getElementById('live_logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
            logElement.textContent = logEntry;
            logsContainer.appendChild(logElement);
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateStats(crawledCount, totalCount) {
            document.getElementById('total_crawled').textContent = crawledCount;
            
            const successRate = totalCount > 0 ? Math.round((crawledCount / totalCount) * 100) : 0;
            document.getElementById('success_rate').textContent = `${successRate}%`;
            
            if (crawlStartTime) {
                const elapsed = Math.round((Date.now() - crawlStartTime) / 1000);
                document.getElementById('avg_time').textContent = `${elapsed}s`;
            }
            
            document.getElementById('last_crawl').textContent = new Date().toLocaleTimeString('fa-IR');
        }

        async function startAdvancedCrawl() {
            const dateFrom = document.getElementById('adv_date_from').value;
            const dateTo = document.getElementById('adv_date_to').value;
            const lang = document.getElementById('adv_lang').value;
            const keywords = document.getElementById('adv_keywords').value;
            const pages = document.getElementById('adv_pages').value;
            const limit = document.getElementById('adv_limit').value;

            if (!dateFrom || !dateTo) {
                alert('Ù„Ø·ÙØ§ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†ØªØ§ÛŒØ¬ Ù‚Ø¨Ù„ÛŒ
            document.getElementById('crawl_results').innerHTML = '';
            crawlLogs = [];
            crawlStartTime = Date.now();

            addLog('Ø´Ø±ÙˆØ¹ Ú©Ø±Ø§ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡...', 'info');

            try {
                const response = await fetch('/advanced_crawl', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        date_from: dateFrom,
                        date_to: dateTo,
                        language: lang,
                        keywords: keywords,
                        max_pages: parseInt(pages),
                        limit: parseInt(limit)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`Ú©Ø±Ø§ÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. ${data.news_count} Ø®Ø¨Ø± Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´Ø¯.`, 'success');
                    updateStats(data.news_count, data.news_count);
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬
                    displayResults(data.news || []);
                } else {
                    addLog(`Ø®Ø·Ø§ Ø¯Ø± Ú©Ø±Ø§ÙˆÙ„: ${data.detail}`, 'error');
                }

            } catch (error) {
                addLog(`Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±: ${error.message}`, 'error');
            }
        }

        function displayResults(news) {
            const resultsContainer = document.getElementById('crawl_results');
            
            if (news.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Ù‡ÛŒÚ† Ø®Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯
                    </div>
                `;
                return;
            }

            let resultsHTML = '';
            news.forEach((item, index) => {
                resultsHTML += `
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition duration-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${item.language}</span>
                            <span class="text-xs text-gray-500">${new Date(item.published).toLocaleDateString('fa-IR')}</span>
                        </div>
                        <h4 class="font-medium text-sm mb-2 line-clamp-2">${item.title}</h4>
                        <p class="text-xs text-gray-600 line-clamp-2">${item.highlight_text || 'Ø¨Ø¯ÙˆÙ† Ù…ØªÙ†'}</p>
                    </div>
                `;
            });

            resultsContainer.innerHTML = resultsHTML;
        }

        function resetForm() {
            document.getElementById('adv_date_from').value = '';
            document.getElementById('adv_date_to').value = '';
            document.getElementById('adv_lang').value = 'english';
            document.getElementById('adv_keywords').value = '';
            document.getElementById('adv_pages').value = '3';
            document.getElementById('adv_limit').value = '20';
            
            document.getElementById('crawl_results').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    Ù‡Ù†ÙˆØ² Ú©Ø±Ø§ÙˆÙ„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª
                </div>
            `;
            
            document.getElementById('live_logs').innerHTML = `
                <div class="text-gray-500">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ú©Ø±Ø§ÙˆÙ„...</div>
            `;
            
            crawlLogs = [];
            updateStats(0, 0);
        }

        function clearLogs() {
            document.getElementById('live_logs').innerHTML = `
                <div class="text-gray-500">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ú©Ø±Ø§ÙˆÙ„...</div>
            `;
            crawlLogs = [];
        }

        async function testConnection() {
            addLog('Ø¯Ø± Ø­Ø§Ù„ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ API...', 'info');
            
            try {
                const response = await fetch('/test_connection');
                
                if (response.ok) {
                    addLog('Ø§ØªØµØ§Ù„ Ø¨Ù‡ API Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØ³Øª Ø´Ø¯', 'success');
                } else {
                    addLog('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ API', 'error');
                }
            } catch (error) {
                addLog(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø§ØªØµØ§Ù„: ${error.message}`, 'error');
            }
        }

        // Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡ Ø±Ùˆ Ø¨Ø§ Ø§ÛŒÙ†ØªØ± Ù‡Ù… Ø¨Ø´Ù‡ Ø«Ø¨Øª Ú©Ø±Ø¯
        document.getElementById('adv_keywords').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startAdvancedCrawl();
            }
        });
    </script>
</body>
</html>