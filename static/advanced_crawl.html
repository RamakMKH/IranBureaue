<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کراول پیشرفته - سیستم اخبار</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazir-font@33.0.0/dist/font-face.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .bg-gradient { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- هدر -->
    <div class="bg-gradient text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">کراول پیشرفته اخبار</h1>
            <div class="space-x-4">
                <a href="#" id="dashboard-link" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-200">
                    بازگشت به داشبورد
                </a>
                <form id="logout-form" method="POST" class="inline">
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        🚪 خروج
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-6">
        <!-- فرم کراول پیشرفته -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-6 border-b pb-2">تنظیمات کراول پیشرفته</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- بخش تاریخ -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">📅 بازه زمانی</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">از تاریخ</label>
                            <input type="date" id="adv_date_from" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تا تاریخ</label>
                            <input type="date" id="adv_date_to" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- بخش زبان -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">🌍 زبان و منطقه</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">زبان خبر</label>
                            <select id="adv_lang" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="english">🇺🇸 انگلیسی</option>
                                <option value="french">🇫🇷 فرانسوی</option>
                                <option value="german">🇩🇪 آلمانی</option>
                                <option value="russian">🇷🇺 روسی</option>
                                <option value="arabic">🇸🇦 عربی</option>
                                <option value="chinese">🇨🇳 چینی</option>
                                <option value="azerbaijani">🇦🇿 آذری</option>
                                <option value="turkish">🇹🇷 ترکی</option>
                                <option value="spanish">🇪🇸 اسپانیایی</option>
                                <option value="italian">🇮🇹 ایتالیایی</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- بخش کلیدواژه و فیلترهای پیشرفته -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- بخش کلیدواژه -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">🔍 جستجوی کلیدواژه</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">کلیدواژه‌ها (اختیاری)</label>
                            <input type="text" id="adv_keywords" placeholder="مثال: nuclear, sanctions, economy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">کلمات را با کاما جدا کنید</p>
                        </div>
                    </div>
                </div>

                <!-- بخش تنظیمات پیشرفته -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-gray-800">⚙️ تنظیمات پیشرفته</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">تعداد صفحات (1-10)</label>
                            <input type="number" id="adv_pages" min="1" max="10" value="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">حداکثر نتایج (1-100)</label>
                            <input type="number" id="adv_limit" min="1" max="100" value="20" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- دکمه‌های اقدام -->
            <div class="flex flex-col md:flex-row gap-4 pt-4 border-t border-gray-200">
                <button onclick="startAdvancedCrawl()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition duration-200 text-lg font-medium">
                    🚀 شروع کراول پیشرفته
                </button>
                <button onclick="resetForm()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-200 text-lg font-medium">
                    🔄 بازنشانی فرم
                </button>
                <button onclick="testConnection()" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg hover:bg-blue-600 transition duration-200 text-lg font-medium">
                    🔌 تست اتصال
                </button>
            </div>
        </div>

        <!-- نتایج و لاگ زنده -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- نتایج کراول -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">📊 نتایج کراول</h3>
                <div id="crawl_results" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        هنوز کراولی انجام نشده است
                    </div>
                </div>
            </div>

            <!-- لاگ زنده -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">📝 لاگ زنده</h3>
                    <button onclick="clearLogs()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition duration-200">
                        پاک کردن
                    </button>
                </div>
                <div id="live_logs" class="bg-gray-50 p-4 rounded-md text-sm font-mono max-h-96 overflow-y-auto">
                    <div class="text-gray-500">منتظر شروع کراول...</div>
                </div>
            </div>
        </div>

        <!-- آمار سریع -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="total_crawled">0</div>
                <div class="text-sm text-gray-600">اخبار جمع‌آوری شده</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="success_rate">0%</div>
                <div class="text-sm text-gray-600">میزان موفقیت</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="avg_time">0s</div>
                <div class="text-sm text-gray-600">میانگین زمان</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-purple-600" id="last_crawl">-</div>
                <div class="text-sm text-gray-600">آخرین کراول</div>
            </div>
        </div>
    </div>

    <script>
        // استخراج خودکار SECRET_PATH از URL فعلی
        const getSecretPath = () => {
            const path = window.location.pathname;
            const match = path.match(/^\/([^\/]+)/);
            return match ? match[1] : 'admin';
        };

        const SECRET_PATH = getSecretPath();

        let crawlLogs = [];
        let crawlStartTime = null;

        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', function() {
            // تنظیم لینک‌ها
            document.getElementById('dashboard-link').href = `/${SECRET_PATH}/dashboard`;
            document.getElementById('logout-form').action = `/${SECRET_PATH}/logout`;
            
            // تنظیم تاریخ پیش‌فرض (امروز و دیروز)
            const today = new Date().toISOString().split('T')[0];
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            document.getElementById('adv_date_from').value = yesterday;
            document.getElementById('adv_date_to').value = today;
        });

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('fa-IR');
            const logEntry = `[${timestamp}] ${message}`;
            crawlLogs.push({ message: logEntry, type });
            
            // نمایش در لاگ زنده
            const logsContainer = document.getElementById('live_logs');
            const logElement = document.createElement('div');
            logElement.className = `mb-1 ${type === 'error' ? 'text-red-600' : type === 'success' ? 'text-green-600' : 'text-gray-700'}`;
            logElement.textContent = logEntry;
            logsContainer.appendChild(logElement);
            
            // اسکرول به پایین
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateStats(crawledCount, totalCount) {
            document.getElementById('total_crawled').textContent = crawledCount;
            
            const successRate = totalCount > 0 ? Math.round((crawledCount / totalCount) * 100) : 0;
            document.getElementById('success_rate').textContent = `${successRate}%`;
            
            if (crawlStartTime) {
                const elapsed = Math.round((Date.now() - crawlStartTime) / 1000);
                document.getElementById('avg_time').textContent = `${elapsed}s`;
            }
            
            document.getElementById('last_crawl').textContent = new Date().toLocaleTimeString('fa-IR');
        }

        async function startAdvancedCrawl() {
            const dateFrom = document.getElementById('adv_date_from').value;
            const dateTo = document.getElementById('adv_date_to').value;
            const lang = document.getElementById('adv_lang').value;
            const keywords = document.getElementById('adv_keywords').value;
            const pages = document.getElementById('adv_pages').value;
            const limit = document.getElementById('adv_limit').value;

            if (!dateFrom || !dateTo) {
                alert('لطفا بازه زمانی را انتخاب کنید');
                return;
            }

            // پاک کردن نتایج قبلی
            document.getElementById('crawl_results').innerHTML = '';
            crawlLogs = [];
            crawlStartTime = Date.now();

            addLog('شروع کراول پیشرفته...', 'info');

            try {
                const response = await fetch('/advanced_crawl', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        date_from: dateFrom,
                        date_to: dateTo,
                        language: lang,
                        keywords: keywords,
                        max_pages: parseInt(pages),
                        limit: parseInt(limit)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog(`کراول با موفقیت انجام شد. ${data.news_count} خبر جمع‌آوری شد.`, 'success');
                    updateStats(data.news_count, data.news_count);
                    
                    // نمایش نتایج
                    displayResults(data.news || []);
                } else {
                    addLog(`خطا در کراول: ${data.detail}`, 'error');
                }

            } catch (error) {
                addLog(`خطا در ارتباط با سرور: ${error.message}`, 'error');
            }
        }

        function displayResults(news) {
            const resultsContainer = document.getElementById('crawl_results');
            
            if (news.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        هیچ خبری یافت نشد
                    </div>
                `;
                return;
            }

            let resultsHTML = '';
            news.forEach((item, index) => {
                resultsHTML += `
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition duration-200">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${item.language}</span>
                            <span class="text-xs text-gray-500">${new Date(item.published).toLocaleDateString('fa-IR')}</span>
                        </div>
                        <h4 class="font-medium text-sm mb-2 line-clamp-2">${item.title}</h4>
                        <p class="text-xs text-gray-600 line-clamp-2">${item.highlight_text || 'بدون متن'}</p>
                    </div>
                `;
            });

            resultsContainer.innerHTML = resultsHTML;
        }

        function resetForm() {
            document.getElementById('adv_date_from').value = '';
            document.getElementById('adv_date_to').value = '';
            document.getElementById('adv_lang').value = 'english';
            document.getElementById('adv_keywords').value = '';
            document.getElementById('adv_pages').value = '3';
            document.getElementById('adv_limit').value = '20';
            
            document.getElementById('crawl_results').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    هنوز کراولی انجام نشده است
                </div>
            `;
            
            document.getElementById('live_logs').innerHTML = `
                <div class="text-gray-500">منتظر شروع کراول...</div>
            `;
            
            crawlLogs = [];
            updateStats(0, 0);
        }

        function clearLogs() {
            document.getElementById('live_logs').innerHTML = `
                <div class="text-gray-500">منتظر شروع کراول...</div>
            `;
            crawlLogs = [];
        }

        async function testConnection() {
            addLog('در حال تست اتصال به API...', 'info');
            
            try {
                const response = await fetch('/test_connection');
                
                if (response.ok) {
                    addLog('اتصال به API با موفقیت تست شد', 'success');
                } else {
                    addLog('خطا در اتصال به API', 'error');
                }
            } catch (error) {
                addLog(`خطا در تست اتصال: ${error.message}`, 'error');
            }
        }

        // کلیدواژه رو با اینتر هم بشه ثبت کرد
        document.getElementById('adv_keywords').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startAdvancedCrawl();
            }
        });
    </script>
</body>
</html>