<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… - Ø³ÛŒØ³ØªÙ… Ø§Ø®Ø¨Ø§Ø±</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazir-font@33.0.0/dist/font-face.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .bg-gradient { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
        .log-container { max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Ù‡Ø¯Ø± -->
    <div class="bg-gradient text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</h1>
            <div class="space-x-4">
                <a href="#" id="dashboard-link" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-200">
                    Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </a>
                <form id="logout-form" method="POST" class="inline">
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        ğŸšª Ø®Ø±ÙˆØ¬
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ Ùˆ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ -->
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ·</label>
                    <select id="log_lines" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="50">ÛµÛ° Ø®Ø· Ø¢Ø®Ø±</option>
                        <option value="100">Û±Û°Û° Ø®Ø· Ø¢Ø®Ø±</option>
                        <option value="200">Û²Û°Û° Ø®Ø· Ø¢Ø®Ø±</option>
                        <option value="500">ÛµÛ°Û° Ø®Ø· Ø¢Ø®Ø±</option>
                        <option value="1000">Û±Û°Û°Û° Ø®Ø· Ø¢Ø®Ø±</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø³Ø·Ø­ Ù„Ø§Ú¯</label>
                    <select id="log_level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">Ù‡Ù…Ù‡</option>
                        <option value="INFO">INFO</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARNING">WARNING</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§</label>
                    <input type="text" id="log_search" placeholder="Ø¹Ø¨Ø§Ø±Øª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                        Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±Ù‡Ø§
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="log_info">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button onclick="downloadLogs()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition duration-200">
                        ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§
                    </button>
                    <button onclick="toggleAutoRefresh()" id="auto_refresh_btn" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition duration-200">
                        ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±: Ø®Ø§Ù…ÙˆØ´
                    </button>
                </div>
            </div>
        </div>

        <!-- Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§ -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</h2>
            </div>
            <div class="log-container">
                <pre id="logs" class="p-4 text-sm font-mono bg-gray-50 min-h-96"></pre>
            </div>
        </div>

        <!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="total_logs">-</div>
                <div class="text-sm text-gray-600">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø·ÙˆØ· Ù„Ø§Ú¯</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="info_logs">-</div>
                <div class="text-sm text-gray-600">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ INFO</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="warning_logs">-</div>
                <div class="text-sm text-gray-600">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ WARNING</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="error_logs">-</div>
                <div class="text-sm text-gray-600">Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ERROR</div>
            </div>
        </div>
    </div>

    <script>
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø®ÙˆØ¯Ú©Ø§Ø± SECRET_PATH Ø§Ø² URL ÙØ¹Ù„ÛŒ
        const getSecretPath = () => {
            const path = window.location.pathname;
            const match = path.match(/^\/([^\/]+)/);
            return match ? match[1] : 'admin';
        };

        const SECRET_PATH = getSecretPath();

        let autoRefreshInterval = null;
        let currentLines = 50;
        let currentLevel = 'all';
        let currentSearch = '';

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§
        document.addEventListener('DOMContentLoaded', function() {
            // ØªÙ†Ø¸ÛŒÙ… Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
            document.getElementById('dashboard-link').href = `/${SECRET_PATH}/dashboard`;
            document.getElementById('logout-form').action = `/${SECRET_PATH}/logout`;
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§
            fetchLogs();
            
            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
            setInterval(fetchLogs, 30000);
        });

        async function fetchLogs() {
            try {
                const response = await fetch(`/${SECRET_PATH}/logs_full?` + new URLSearchParams({
                    lines: currentLines,
                    level: currentLevel,
                    search: currentSearch
                }));
                
                const data = await response.json();
                
                // Ù†Ù…Ø§ÛŒØ´ Ù„Ø§Ú¯â€ŒÙ‡Ø§
                document.getElementById('logs').innerHTML = data.logs || 'Ù„Ø§Ú¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø±
                updateStats(data.stats);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                document.getElementById('log_info').textContent = 
                    `Ù†Ù…Ø§ÛŒØ´ ${data.stats.displayed_lines} Ø®Ø· Ø§Ø² ${data.stats.total_lines} Ø®Ø· Ù„Ø§Ú¯`;
                    
            } catch (error) {
                console.error('Error fetching logs:', error);
                document.getElementById('logs').innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§';
            }
        }

        function updateStats(stats) {
            document.getElementById('total_logs').textContent = stats.total_lines;
            document.getElementById('info_logs').textContent = stats.info_count;
            document.getElementById('warning_logs').textContent = stats.warning_count;
            document.getElementById('error_logs').textContent = stats.error_count;
        }

        function applyFilters() {
            currentLines = document.getElementById('log_lines').value;
            currentLevel = document.getElementById('log_level').value;
            currentSearch = document.getElementById('log_search').value;
            fetchLogs();
        }

        function refreshLogs() {
            fetchLogs();
        }

        function toggleAutoRefresh() {
            const button = document.getElementById('auto_refresh_btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                button.textContent = 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±: Ø®Ø§Ù…ÙˆØ´';
                button.classList.remove('bg-green-600');
                button.classList.add('bg-purple-500');
            } else {
                autoRefreshInterval = setInterval(fetchLogs, 5000); // Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
                button.textContent = 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±: Ø±ÙˆØ´Ù†';
                button.classList.remove('bg-purple-500');
                button.classList.add('bg-green-600');
            }
        }

        async function clearLogs() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.')) {
                try {
                    await fetch(`/${SECRET_PATH}/clear_logs`, {
                        method: 'POST'
                    });
                    fetchLogs();
                    alert('Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÙ‡Ø§');
                }
            }
        }

        async function downloadLogs() {
            try {
                const response = await fetch(`/${SECRET_PATH}/download_logs`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `system_logs_${new Date().toISOString().split('T')[0]}.log`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§');
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù„Ø§Ú¯â€ŒÙ‡Ø§');
            }
        }

        // Ù‚Ø§Ø¨Ù„ÛŒØª Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Ú©Ù„ÛŒØ¯ Enter
        document.getElementById('log_search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>