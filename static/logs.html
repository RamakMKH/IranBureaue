<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لاگ‌های سیستم - سیستم اخبار</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vazir-font@33.0.0/dist/font-face.css" rel="stylesheet">
    <style>
        body { font-family: 'Vazir', sans-serif; }
        .bg-gradient { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
        .log-container { max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- هدر -->
    <div class="bg-gradient text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">لاگ‌های سیستم</h1>
            <div class="space-x-4">
                <a href="#" id="dashboard-link" class="bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition duration-200">
                    بازگشت به داشبورد
                </a>
                <form id="logout-form" method="POST" class="inline">
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                        🚪 خروج
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- فیلترها و کنترل‌ها -->
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">تعداد خطوط</label>
                    <select id="log_lines" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="50">۵۰ خط آخر</option>
                        <option value="100">۱۰۰ خط آخر</option>
                        <option value="200">۲۰۰ خط آخر</option>
                        <option value="500">۵۰۰ خط آخر</option>
                        <option value="1000">۱۰۰۰ خط آخر</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">سطح لاگ</label>
                    <select id="log_level" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="all">همه</option>
                        <option value="INFO">INFO</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARNING">WARNING</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">جستجو در لاگ‌ها</label>
                    <input type="text" id="log_search" placeholder="عبارت مورد نظر..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">
                        اعمال فیلترها
                    </button>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="log_info">در حال بارگذاری...</span>
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button onclick="downloadLogs()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600 transition duration-200">
                        📥 دانلود لاگ‌ها
                    </button>
                    <button onclick="toggleAutoRefresh()" id="auto_refresh_btn" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600 transition duration-200">
                        🔄 بروزرسانی خودکار: خاموش
                    </button>
                </div>
            </div>
        </div>

        <!-- نمایش لاگ‌ها -->
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">لاگ‌های سیستم</h2>
            </div>
            <div class="log-container">
                <pre id="logs" class="p-4 text-sm font-mono bg-gray-50 min-h-96"></pre>
            </div>
        </div>

        <!-- آمار سریع -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600" id="total_logs">-</div>
                <div class="text-sm text-gray-600">تعداد خطوط لاگ</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600" id="info_logs">-</div>
                <div class="text-sm text-gray-600">لاگ‌های INFO</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-yellow-600" id="warning_logs">-</div>
                <div class="text-sm text-gray-600">لاگ‌های WARNING</div>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600" id="error_logs">-</div>
                <div class="text-sm text-gray-600">لاگ‌های ERROR</div>
            </div>
        </div>
    </div>

    <script>
        // استخراج خودکار SECRET_PATH از URL فعلی
        const getSecretPath = () => {
            const path = window.location.pathname;
            const match = path.match(/^\/([^\/]+)/);
            return match ? match[1] : 'admin';
        };

        const SECRET_PATH = getSecretPath();

        let autoRefreshInterval = null;
        let currentLines = 50;
        let currentLevel = 'all';
        let currentSearch = '';

        // بارگذاری اولیه لاگ‌ها
        document.addEventListener('DOMContentLoaded', function() {
            // تنظیم لینک‌ها
            document.getElementById('dashboard-link').href = `/${SECRET_PATH}/dashboard`;
            document.getElementById('logout-form').action = `/${SECRET_PATH}/logout`;
            
            // بارگذاری لاگ‌ها
            fetchLogs();
            
            // بروزرسانی خودکار هر 30 ثانیه
            setInterval(fetchLogs, 30000);
        });

        async function fetchLogs() {
            try {
                const response = await fetch(`/${SECRET_PATH}/logs_full?` + new URLSearchParams({
                    lines: currentLines,
                    level: currentLevel,
                    search: currentSearch
                }));
                
                const data = await response.json();
                
                // نمایش لاگ‌ها
                document.getElementById('logs').innerHTML = data.logs || 'لاگی یافت نشد';
                
                // به‌روزرسانی آمار
                updateStats(data.stats);
                
                // به‌روزرسانی اطلاعات
                document.getElementById('log_info').textContent = 
                    `نمایش ${data.stats.displayed_lines} خط از ${data.stats.total_lines} خط لاگ`;
                    
            } catch (error) {
                console.error('Error fetching logs:', error);
                document.getElementById('logs').innerHTML = 'خطا در بارگذاری لاگ‌ها';
            }
        }

        function updateStats(stats) {
            document.getElementById('total_logs').textContent = stats.total_lines;
            document.getElementById('info_logs').textContent = stats.info_count;
            document.getElementById('warning_logs').textContent = stats.warning_count;
            document.getElementById('error_logs').textContent = stats.error_count;
        }

        function applyFilters() {
            currentLines = document.getElementById('log_lines').value;
            currentLevel = document.getElementById('log_level').value;
            currentSearch = document.getElementById('log_search').value;
            fetchLogs();
        }

        function refreshLogs() {
            fetchLogs();
        }

        function toggleAutoRefresh() {
            const button = document.getElementById('auto_refresh_btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                button.textContent = '🔄 بروزرسانی خودکار: خاموش';
                button.classList.remove('bg-green-600');
                button.classList.add('bg-purple-500');
            } else {
                autoRefreshInterval = setInterval(fetchLogs, 5000); // هر 5 ثانیه
                button.textContent = '🔄 بروزرسانی خودکار: روشن';
                button.classList.remove('bg-purple-500');
                button.classList.add('bg-green-600');
            }
        }

        async function clearLogs() {
            if (confirm('آیا از پاک کردن لاگ‌ها مطمئن هستید؟ این عمل غیرقابل بازگشت است.')) {
                try {
                    await fetch(`/${SECRET_PATH}/clear_logs`, {
                        method: 'POST'
                    });
                    fetchLogs();
                    alert('لاگ‌ها با موفقیت پاک شدند');
                } catch (error) {
                    alert('خطا در پاک کردن لاگ‌ها');
                }
            }
        }

        async function downloadLogs() {
            try {
                const response = await fetch(`/${SECRET_PATH}/download_logs`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `system_logs_${new Date().toISOString().split('T')[0]}.log`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('خطا در دانلود لاگ‌ها');
                }
            } catch (error) {
                alert('خطا در دانلود لاگ‌ها');
            }
        }

        // قابلیت جستجو با کلید Enter
        document.getElementById('log_search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>